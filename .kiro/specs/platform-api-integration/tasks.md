# 实施计划：平台 API 集成

## 概述

本实施计划将当前基于模拟实现的平台适配器升级为真实平台 API 对接。系统将保持现有架构，通过扩展现有的 `BaseAdapter` 和各平台适配器类来实现真实 API 调用，同时支持模拟模式和真实模式的平滑切换。

实施策略：
- 采用增量式开发，每个任务独立可测试
- 优先实现核心功能，测试任务标记为可选
- 在关键节点设置检查点，确保代码质量
- 所有任务基于现有代码结构，最小化侵入性修改

## 任务列表

- [ ] 1. 配置管理与错误处理基础设施
  - [x] 1.1 扩展配置管理支持平台 API 凭证
    - 在 `src/main/services/platform-adapters.js` 中扩展 `BaseAdapter` 构造函数，支持从环境变量读取 API 凭证
    - 添加配置验证逻辑，确保必需的配置项存在且有效
    - 支持配置 API 端点 URL、超时时间、运行模式（mock/real）
    - _需求：1.1, 1.2, 1.3, 1.4_

  - [x] 1.2 实现统一错误码枚举和错误映射
    - 在 `PlatformApiError` 类中定义统一错误码常量（AUTH_FAILED、RATE_LIMIT、INVALID_PAYLOAD、TIMEOUT、CAPTCHA_REQUIRED、CONTENT_VIOLATION）
    - 扩展 `BaseAdapter.mapApiError()` 方法，支持映射所有错误类型
    - 为每种错误类型提供清晰的中文错误消息
    - _需求：5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7_

  - [x] 1.3 编写配置管理和错误映射的单元测试
    - 测试配置验证逻辑的各种场景（缺失配置、无效配置）
    - 测试错误映射的准确性
    - _需求：1.5, 5.1_

- [ ] 2. 内容合规检查工具
  - [x] 2.1 实现敏感词检查工具
    - 在 `src/main/utils/` 目录创建 `content-validator.js` 文件
    - 实现 `checkSensitiveWords(content, wordList)` 函数
    - 实现 `validateContentFormat(content, platform)` 函数，检查标题长度、正文长度、图片数量等
    - 支持从配置文件加载敏感词词库
    - _需求：7.1, 7.2, 7.3, 7.4, 7.5_

  - [x] 2.2 编写内容合规检查的单元测试
    - 测试敏感词检测的准确性
    - 测试格式验证的各种边界情况
    - _需求：7.1, 7.4_

- [x] 3. 检查点 - 确保基础设施代码通过测试
  - 确保所有测试通过，如有疑问请询问用户

- [ ] 4. 抖音平台 API 对接
  - [x] 4.1 实现抖音平台鉴权逻辑
    - 在 `DouyinAdapter` 类中实现 `authenticate()` 方法
    - 实现 OAuth 2.0 鉴权流程或平台指定的鉴权方式
    - 处理 access token 的获取、刷新和缓存
    - _需求：2.1_

  - [x] 4.2 实现抖音图文发布 API 调用
    - 在 `DouyinAdapter` 类中实现 `publishImageText()` 方法
    - 调用抖音开放平台的图文发布接口
    - 处理图片上传和内容提交的完整流程
    - _需求：2.2_

  - [x] 4.3 实现抖音视频发布 API 调用
    - 在 `DouyinAdapter` 类中实现 `publishVideo()` 方法
    - 调用抖音开放平台的视频发布接口
    - 处理视频上传和内容提交的完整流程
    - _需求：2.3_

  - [x] 4.4 集成抖音错误处理和限流控制
    - 在 `DouyinAdapter.publish()` 方法中集成内容合规检查
    - 实现抖音平台错误码到统一错误类型的映射
    - 确保遵守抖音平台的 API 调用频率限制
    - 返回抖音平台的内容 ID
    - _需求：2.4, 2.5, 2.6_

  - [ ] 4.5 编写抖音适配器的单元测试
    - 测试鉴权流程
    - 测试图文和视频发布的各种场景
    - 测试错误处理逻辑
    - _需求：2.1, 2.2, 2.3, 2.4_

- [ ] 5. 小红书平台 API 对接
  - [~] 5.1 实现小红书平台鉴权逻辑
    - 在 `XiaohongshuAdapter` 类中实现 `authenticate()` 方法
    - 实现小红书平台指定的鉴权方式
    - 处理 access token 的获取、刷新和缓存
    - _需求：3.1_

  - [~] 5.2 实现小红书笔记发布 API 调用
    - 在 `XiaohongshuAdapter` 类中实现 `publishNote()` 方法
    - 调用小红书开放平台的笔记发布接口
    - 处理图片上传和笔记内容提交的完整流程
    - _需求：3.2_

  - [~] 5.3 集成小红书错误处理和限流控制
    - 在 `XiaohongshuAdapter.publish()` 方法中集成内容合规检查
    - 实现小红书平台错误码到统一错误类型的映射
    - 确保遵守小红书平台的 API 调用频率限制
    - 返回小红书平台的笔记 ID
    - _需求：3.3, 3.4, 3.5_

  - [~] 5.4 编写小红书适配器的单元测试
    - 测试鉴权流程
    - 测试笔记发布的各种场景
    - 测试错误处理逻辑
    - _需求：3.1, 3.2, 3.3_

- [ ] 6. 头条平台 API 对接
  - [~] 6.1 实现头条平台鉴权逻辑
    - 在 `ToutiaoAdapter` 类中实现 `authenticate()` 方法
    - 实现头条平台指定的鉴权方式
    - 处理 access token 的获取、刷新和缓存
    - _需求：4.1_

  - [~] 6.2 实现头条文章发布 API 调用
    - 在 `ToutiaoAdapter` 类中实现 `publishArticle()` 方法
    - 调用头条开放平台的文章发布接口
    - 处理图片上传和文章内容提交的完整流程
    - _需求：4.2_

  - [~] 6.3 集成头条错误处理和限流控制
    - 在 `ToutiaoAdapter.publish()` 方法中集成内容合规检查
    - 实现头条平台错误码到统一错误类型的映射
    - 确保遵守头条平台的 API 调用频率限制
    - 返回头条平台的文章 ID
    - _需求：4.3, 4.4, 4.5_

  - [~] 6.4 编写头条适配器的单元测试
    - 测试鉴权流程
    - 测试文章发布的各种场景
    - 测试错误处理逻辑
    - _需求：4.1, 4.2, 4.3_

- [~] 7. 检查点 - 确保所有平台适配器实现完成
  - 确保所有测试通过，如有疑问请询问用户

- [ ] 8. 验证码与风控处理
  - [~] 8.1 实现验证码检测和任务状态管理
    - 在 `BaseAdapter.mapApiError()` 中添加验证码错误检测逻辑
    - 在 `src/main/services/matrix-service.js` 中添加任务状态更新逻辑，支持 `captcha_required` 状态
    - 当检测到验证码要求时，更新任务状态为 `captcha_required`
    - _需求：6.1_

  - [~] 8.2 实现验证码告警通知
    - 在 `src/main/services/alert-reporter.js` 中添加验证码告警方法
    - 当任务状态变为 `captcha_required` 时，发送告警通知
    - _需求：6.2_

  - [~] 8.3 实现人工接管接口
    - 在 `src/main/services/matrix-service.js` 中添加 `manualTakeover(taskId)` 方法
    - 支持运营人员手动完成验证后继续任务
    - 将任务状态从 `captcha_required` 更新为 `scheduled` 并重新执行
    - _需求：6.3, 6.4_

  - [~] 8.4 实现人工接管超时处理
    - 在定时任务中检查 `captcha_required` 状态的任务
    - 如果超过 24 小时未处理，将任务标记为 `failed`
    - _需求：6.5_

  - [~] 8.5 编写验证码处理的单元测试
    - 测试验证码检测逻辑
    - 测试任务状态转换
    - 测试人工接管流程
    - _需求：6.1, 6.3, 6.4_

- [ ] 9. 增强的重试策略
  - [~] 9.1 实现智能重试逻辑
    - 在 `src/main/services/matrix-service.js` 中扩展 `runDueTasks()` 方法
    - 根据错误类型实施不同的重试策略：
      - RATE_LIMIT：等待指定时间后重试
      - TIMEOUT：立即重试
      - AUTH_FAILED：不重试，立即标记为 failed
      - CAPTCHA_REQUIRED：不自动重试，等待人工接管
    - 记录每次重试的时间和原因
    - 当重试次数超过最大值时，标记任务为 failed
    - _需求：8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7_

  - [~] 9.2 编写重试策略的单元测试
    - 测试各种错误类型的重试行为
    - 测试重试次数限制
    - 测试重试记录
    - _需求：8.2, 8.3, 8.4, 8.5_

- [ ] 10. 发布结果追踪
  - [~] 10.1 扩展数据库模型记录发布详情
    - 在 `src/main/services/matrix-service.js` 中扩展数据库表结构
    - 添加字段记录请求参数、响应数据、平台返回 ID、耗时
    - 实现 `recordPublishResult(taskId, result)` 方法
    - _需求：9.1, 9.2, 9.3, 9.4_

  - [~] 10.2 实现发布详情查询接口
    - 在 `src/main/services/matrix-service.js` 中实现 `getPublishDetails(taskId)` 方法
    - 实现 `getRecentFailures(limit)` 方法，查询最近的发布失败记录
    - _需求：9.5, 9.6_

  - [~] 10.3 编写发布追踪的单元测试
    - 测试发布结果记录
    - 测试查询接口
    - _需求：9.1, 9.5_

- [ ] 11. 发布数据分析
  - [~] 11.1 实现发布指标统计
    - 在 `src/main/services/matrix-service.js` 中实现 `getPublishMetrics(platform, startDate, endDate)` 方法
    - 统计每个平台的发布成功率
    - 统计每个平台的平均发布耗时
    - 统计各类错误的发生频率
    - _需求：10.1, 10.2, 10.3, 10.4_

  - [~] 11.2 实现发布趋势数据接口
    - 实现 `getPublishTrend(platform, startDate, endDate)` 方法
    - 返回按日期分组的成功数和失败数
    - 支持生成图表所需的数据格式
    - _需求：10.5_

  - [~] 11.3 编写数据分析的单元测试
    - 测试指标统计的准确性
    - 测试趋势数据生成
    - _需求：10.1, 10.2, 10.3_

- [ ] 12. 平滑迁移支持
  - [~] 12.1 实现运行模式配置和切换
    - 确保 `PlatformAdapterRegistry` 支持为每个平台独立配置运行模式
    - 在日志中明确标识当前使用的模式（mock/real）
    - 支持通过环境变量或配置文件切换模式
    - _需求：11.1, 11.2, 11.3, 11.4_

  - [~] 12.2 实现配置热重载（可选）
    - 支持在运行时通过配置文件切换模式，无需重启应用
    - 实现配置文件监听和重载机制
    - _需求：11.5_

  - [~] 12.3 编写模式切换的单元测试
    - 测试模式配置的正确性
    - 测试模式切换的行为
    - _需求：11.1, 11.2, 11.3_

- [ ] 13. IPC 接口集成
  - [~] 13.1 添加前端调用接口
    - 在 `src/main/ipc/` 目录中添加或更新 IPC 处理器
    - 暴露人工接管接口、发布详情查询接口、数据分析接口
    - 确保前端可以调用所有新增功能
    - _需求：6.3, 9.5, 10.1_

  - [~] 13.2 编写 IPC 接口的集成测试
    - 测试前端到后端的完整调用链路
    - _需求：6.3, 9.5_

- [~] 14. 最终检查点 - 完整性验证
  - 确保所有测试通过
  - 验证所有需求都已实现
  - 检查日志输出是否清晰
  - 如有疑问请询问用户

## 注意事项

- 标记 `*` 的任务为可选任务，可以跳过以加快 MVP 交付
- 每个任务都明确引用了对应的需求编号，便于追溯
- 检查点任务确保增量验证，及时发现问题
- 所有实现基于现有代码结构，保持架构一致性
- 优先实现核心发布功能，测试和分析功能可后续补充
